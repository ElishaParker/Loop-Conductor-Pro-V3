<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LoopConductor Pro v3.3</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<!-- Splash Screen -->
<div id="splash">
  <div id="splashContent">
    <h1>üéµ LoopConductor Pro v3.3.2</h1>
    <p id="splashStatus">Initializing Audio Engine‚Ä¶</p>

    <div id="loadingBar">
      <div id="loadingProgress"></div>
    </div>

    <button id="continueBtn" style="display:none;">Continue</button>

    <p class="donate">
      Support open development:
      <a href="https://paypal.me/iamvibration" target="_blank">paypal.me/iamvibration</a>
    </p>
  </div>
</div>



  <!-- Main App -->
  <div id="mainApp" style="display:none;">
    <h1>LoopConductor Pro v3.3</h1>
    <div class="global-controls">
      <label>Master Volume:</label>
      <input id="masterVolume" type="range" min="0" max="1" step="0.01" value="0.8" />
      <button id="playAll">‚ñ∂ Play All</button>
      <button id="stopAll">‚èπ Stop All</button>
      <button id="addTrack">‚ûï Add Track</button>
    </div>
    <div id="trackContainer" class="track-container"></div>
    <footer>
      LoopConductor Pro v3.3 ‚Äî ¬© 2025 Elisha B. Parker
      <a href="https://github.com/ElishaParker/Loop-Conductor-Pro" target="_blank">GitHub</a>
    </footer>
  </div>

  <script type="module">
    import { createTrack, playAll, stopAll, setGlobalVolume, initializeAudio } from "./loopconductor.js";

    const splash = document.getElementById("splash");
    const mainApp = document.getElementById("mainApp");
    const progress = document.getElementById("loadingProgress");

async function initApp() {
  // Start the progress bar animation
  progress.classList.add("animate");

  // ‚úÖ Create shared AudioContext immediately, but suspended
  if (!window.sharedAudioCtx) {
    window.sharedAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }

  // Resume context safely once user interacts anywhere
  const unlock = () => {
    if (window.sharedAudioCtx.state === "suspended") {
      window.sharedAudioCtx.resume();
    }
    document.removeEventListener("click", unlock);
    document.removeEventListener("keydown", unlock);
  };
  document.addEventListener("click", unlock);
  document.addEventListener("keydown", unlock);

  // Begin background warm-up (connect oscillators, LFOs, etc.)
  await initializeAudio();

  // Fade out splash when timer completes
  setTimeout(() => {
    splash.classList.add("fade-out");
    setTimeout(() => {
      splash.style.display = "none";
      mainApp.style.display = "block";
      bootMain(); // by now AudioContext is warm and unlocked
    }, 1000);
  }, 7000);
}








    function bootMain() {
      const container = document.getElementById("trackContainer");
      const addBtn = document.getElementById("addTrack");
      const playAllBtn = document.getElementById("playAll");
      const stopAllBtn = document.getElementById("stopAll");
      const masterVol = document.getElementById("masterVolume");
      let tracks = [];

      function updateTitles() {
        tracks.forEach((t, i) => t.querySelector(".track-title").textContent = "Track " + (i + 1));
      }

      addBtn.onclick = () => {
        const last = tracks.length ? tracks[tracks.length - 1].dataset.settings : null;
        const newTrack = createTrack(container, last);
        tracks.push(newTrack);
        updateTitles();
      };

      playAllBtn.onclick = () => playAll(tracks);
      stopAllBtn.onclick = () => stopAll(tracks);
      masterVol.oninput = e => setGlobalVolume(parseFloat(e.target.value));

      addBtn.click();
    }

    initApp();
  </script>
</body>
</html>
