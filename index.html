<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Loop Conductor Pro vFinal</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Splash Screen -->
  <div id="splash">
    <div id="splashContent">
      <h1>üéµ Loop Conductor Pro vFinal</h1>
      <p>Initializing Audio Engine‚Ä¶</p>
      <div id="loadingBar"><div id="loadingProgress"></div></div>
      <p class="donate">
        Support open-source development:<br>
        <a href="https://paypal.me/iamvibration" target="_blank">paypal.me/iamvibration</a>
      </p>
    </div>
  </div>

  <!-- Main Application -->
  <div id="mainApp" style="display:none;">
    <h1>Loop Conductor Pro vFinal</h1>

    <div class="global-controls">
      <label>Master Volume:</label>
      <input id="masterVolume" type="range" min="0" max="1" step="0.01" value="0.8" />
      <button id="playAll">‚ñ∂ Play All</button>
      <button id="stopAll">‚èπ Stop All</button>
      <button id="addTrack">‚ûï Add Track</button>
    </div>

    <div id="trackContainer" class="track-container"></div>

    <footer>
      Loop Conductor Pro vFinal ‚Äî ¬© 2025 Elisha B. Parker
      <a href="https://github.com/ElishaParker/Loop-Conductor-Pro-V3" target="_blank">GitHub</a>
    </footer>
  </div>

  <!-- Core Script -->
<script type="module">
  import {
    createTrack, playAll, stopAll, setGlobalVolume, initializeAudio
  } from "./loopconductor.js";

  const splash = document.getElementById("splash");
  const mainApp = document.getElementById("mainApp");
  const progress = document.getElementById("loadingProgress");
  let audioReady = false;

  async function initApp() {
    // Wait for user click to start audio context
    document.body.addEventListener("click", async function startOnce() {
      document.body.removeEventListener("click", startOnce);
      try {
        await initializeAudio();
        audioReady = true;
        console.log("‚úÖ Audio engine initialized");
        startSplash();
      } catch (err) {
        console.error("Audio initialization failed:", err);
      }
    });
    console.log("üëÜ Click anywhere to begin audio initialization");
  }

  // Splash sequence after audio ready
  function startSplash() {
    let pct = 0;
    const intv = setInterval(() => {
      pct += 2;
      progress.style.width = pct + "%";
      if (pct >= 100) {
        clearInterval(intv);
        splash.classList.add("fade-out");
        setTimeout(() => {
          splash.style.display = "none";
          mainApp.style.display = "block";
          if (audioReady) bootMain();
          else console.error("Audio engine not ready at splash end.");
        }, 1000);
      }
    }, 140);
  }

  // Main engine UI setup
  function bootMain() {
    const container = document.getElementById("trackContainer");
    const addBtn = document.getElementById("addTrack");
    const playBtn = document.getElementById("playAll");
    const stopBtn = document.getElementById("stopAll");
    const masterVol = document.getElementById("masterVolume");
    const tracks = [];

    const updateTitles = () => {
      tracks.forEach((t, i) => t.querySelector(".track-title").textContent = "Track " + (i + 1));
    };

    addBtn.onclick = () => {
      if (!audioReady) {
        console.warn("Audio not ready yet, ignoring track creation");
        return;
      }
      const lastSettings = tracks.length ? tracks[tracks.length - 1].dataset.settings : null;
      const newTrack = createTrack(container, lastSettings);
      tracks.push(newTrack);
      updateTitles();
    };

    playBtn.onclick = () => playAll(tracks);
    stopBtn.onclick = () => stopAll(tracks);
    masterVol.oninput = e => setGlobalVolume(parseFloat(e.target.value));

    // Only add default track after verified audio context
    if (audioReady) addBtn.click();
  }

  window.addEventListener("load", initApp);
</script>


  // Main app controls
  function bootMain() {
    const container = document.getElementById("trackContainer");
    const addBtn = document.getElementById("addTrack");
    const playBtn = document.getElementById("playAll");
    const stopBtn = document.getElementById("stopAll");
    const masterVol = document.getElementById("masterVolume");
    const tracks = [];

    function updateTitles() {
      tracks.forEach((t, i) => t.querySelector(".track-title").textContent = "Track " + (i + 1));
    }

    addBtn.onclick = () => {
      const lastSettings = tracks.length ? tracks[tracks.length - 1].dataset.settings : null;
      const newTrack = createTrack(container, lastSettings);
      tracks.push(newTrack);
      updateTitles();
    };

    playBtn.onclick = () => playAll(tracks);
    stopBtn.onclick = () => stopAll(tracks);
    masterVol.oninput = e => setGlobalVolume(parseFloat(e.target.value));

    // Create first track after engine is ready
    addBtn.click();
  }

  window.addEventListener("load", initApp);
</script>


    // Main UI Logic
    function bootMain() {
      const container = document.getElementById("trackContainer");
      const addBtn = document.getElementById("addTrack");
      const playBtn = document.getElementById("playAll");
      const stopBtn = document.getElementById("stopAll");
      const masterVol = document.getElementById("masterVolume");

      let tracks = [];

      // Title Update
      function updateTitles() {
        tracks.forEach((t, i) => t.querySelector(".track-title").textContent = "Track " + (i + 1));
      }

      // Add Track
      addBtn.onclick = () => {
        const lastSettings = tracks.length ? tracks[tracks.length - 1].dataset.settings : null;
        const newTrack = createTrack(container, lastSettings);
        tracks.push(newTrack);
        updateTitles();
      };

      // Global Controls
      playBtn.onclick = () => playAll(tracks);
      stopBtn.onclick = () => stopAll(tracks);
      masterVol.oninput = e => setGlobalVolume(parseFloat(e.target.value));

      // Auto-create first track
      addBtn.click();
    }

    window.addEventListener("load", initApp);
  </script>
</body>
</html>
